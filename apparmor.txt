include <tunables/global>

profile claptrap flags=(attach_disconnected,mediate_deleted) {
  include <abstractions/base>
  include <abstractions/audio>
  include <abstractions/python>
  include <abstractions/nameservice>

  # Permissions de base
  capability net_admin,
  capability net_raw,
  capability net_bind_service,

  # Accès aux fichiers de l'add-on
  /claptrap/** rwk,
  /claptrap/data/** rwk,
  /claptrap/run.sh rix,

  # Python et dépendances
  /usr/bin/python3.10 ix,
  /usr/local/lib/python3.10/** rm,
  /usr/local/bin/python3.10 ix,

  # Accès réseau pour RTSP et webhooks
  network tcp,
  network udp,

  # Accès aux périphériques audio
  /dev/snd/* rw,
  /dev/shm/** rwk,

  # Accès aux fichiers temporaires
  /tmp/** rwk,
  /var/tmp/** rwk,

  # Accès aux logs
  /var/log/claptrap.log rwk,

  # Accès aux bibliothèques système nécessaires
  /usr/lib/** rm,
  /lib/** rm,

  # Accès aux périphériques vidéo (pour OpenCV)
  /dev/video* rw,

  # Accès aux fichiers de configuration
  owner /data/** rw,

  # FFmpeg
  /usr/bin/ffmpeg ix,
  /usr/bin/ffprobe ix,

  # Permissions pour MediaPipe
  /sys/devices/system/cpu/cpu*/cache/** r,
  /sys/devices/system/cpu/** r,

  # Deny everything else
  deny @{PROC}/{*,**^[0-9*],sys/kernel/shm*} wkx,
  deny @{PROC}/sys/kernel/shmmax w,
  deny @{PROC}/sys/kernel/shmall w,
  deny @{PROC}/sysrq-trigger rwklx,
  deny @{PROC}/mem rwklx,
  deny @{PROC}/kmem rwklx,
  deny @{PROC}/kcore rwklx,
  deny mount,
  deny /sys/[^f]*/** wklx,
  deny /sys/f[^s]*/** wklx,
  deny /sys/fs/[^c]*/** wklx,
  deny /sys/fs/c[^g]*/** wklx,
  deny /sys/fs/cg[^r]*/** wklx,
  deny /sys/firmware/** rwklx,
  deny /sys/kernel/security/** rwklx,
} 